<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Current Trip for {{ bus_name }}</title>
    <link rel="icon" href="/static/busiloo.svg" type="image/svg+xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/trip.css">

</head>
<body>

    <!-- The initial loading message is displayed immediately from the HTML. -->
    <div id="trip-info" >
        <p style="text-align: center; padding-top: 50px;">Loading trip information...<br><br>Please note: The scheduled bus time and timeline chart may be inaccurate based on traffic and other conditions.</p>
    </div>
    <button id="scroll-to-bus-btn"><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <g>
            <path fill="none" d="M0 0h24v24H0z"/>
            <path fill="currentColor" d="M18.033 16.618l4.28 4.281-1.414 1.415-4.28-4.281A8.963 8.963 0 0 1 11 20a8.998 8.998 0 0 1-8.065-5H9l-1.304 2.173A6.972 6.972 0 0 0 11 18a6.977 6.977 0 0 0 4.875-1.975l.15-.15A6.977 6.977 0 0 0 18 11c0-.695-.101-1.366-.29-2h2.067c.146.643.223 1.313.223 2a8.963 8.963 0 0 1-1.967 5.618zM19.065 7H13l1.304-2.173A6.972 6.972 0 0 0 11 4c-3.868 0-7 3.132-7 7 0 .695.101 1.366.29 2H2.223A9.038 9.038 0 0 1 2 11c0-4.973 4.027-9 9-9a8.998 8.998 0 0 1 8.065 5z"/>
        </g>
    </svg></button>

    <!-- The modal structure is kept in the HTML for semantic structure. -->
    <div id="crowd-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" id="close-modal-btn">&times;</span>
            <h3>Report Crowd Level</h3>
            <p>Your input helps everyone travel smarter.</p>
            <div id="crowd-form">
                <label for="crowd-level">How busy is the bus right now?</label>
                <select id="crowd-level">
                    <option value="1">Empty seats available (Low)</option>
                    <option value="2">All seats taken (Medium)</option>
                    <option value="3">Standing room only (High)</option>
                </select>
                <button id="submit-crowd-btn">Submit</button>
                <p id="submit-status" style="margin-top:10px; text-align:center;"></p>
            </div>
        </div>
    </div>


    <script defer>
        const BUS_ID = {{ bus_id }};
        console.log('BUS_ID:', BUS_ID); // Check what value BUS_ID actually holds
        const BUS_NAME = "{{ bus_name }}";
        const tripInfo = document.getElementById('trip-info');
        const scrollBtn = document.getElementById('scroll-to-bus-btn');
        let is24Hour = true;
        let shouldShowTooltip = true;
        let tooltipTimeout;




        const RECENT_KEY = 'recentTrips';
        function loadRecent() {
        try { return JSON.parse(localStorage.getItem(RECENT_KEY)) || []; }
        catch { return []; }
        }
        function saveRecent(list) {
        localStorage.setItem(RECENT_KEY, JSON.stringify(list));
        }
        function recordThisTrip(trip) {
        console.log('recordThisTrip called with tripData:', trip); 
        const url = location.pathname + location.search;
        const entry = {
            url,
            busId: BUS_ID,
            tripName: trip.route_name,
            busName: BUS_NAME,
            
            when: Date.now()
        };
        let list = loadRecent().filter(e => e.url !== url);
        list.unshift(entry);
        if (list.length > 10) list.pop();
        saveRecent(list);
        }

    
        // --- TIME FORMATTING UTILITIES (Unchanged) ---
        function formatTime(input, showSeconds) {
            let date;
            if (input instanceof Date) {
                date = input;
            } else if (typeof input === 'string') {
                const parts = input.split(':').map(Number);
                date = new Date();
                date.setHours(parts[0], parts[1], parts[2] || 0, 0);
            } else {
                return '';
            }
            const options = { hour: 'numeric', minute: '2-digit', hour12: !is24Hour, timeZone: 'Asia/Kolkata' };
            if (showSeconds) options.second = '2-digit';
            return new Intl.DateTimeFormat('en-US', options).format(date);
        }
    
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [h, m, s = 0] = timeStr.split(':').map(Number);
            return h * 60 + m + s / 60;
        }
    
        function calculateETA(currentMinutes, stopTimeMinutes) {
            const diff = stopTimeMinutes - currentMinutes;
        
            if (diff <= 0) {
                return 'Departed';
            }
        
            if (diff < 1) {
                return '< 1 min';
            }
        
            if (diff >= 60) {
                const hours = Math.floor(diff / 60);
                const minutes = Math.round(diff % 60);
        
                let etaString = '';
                if (hours > 0) {
                    etaString += `${hours} hr`;
                    if (hours > 1) {
                        etaString += 's'; // Pluralize "hour" if more than 1
                    }
                }
        
                if (minutes > 0) {
                    if (etaString !== '') {
                        etaString += ' '; // Add space if both hours and minutes are present
                    }
                    etaString += `${minutes} min`;
                }
        
                return etaString.trim(); // Trim any leading/trailing spaces
            }
        
            return `~${Math.round(diff)} min`;
        }
        async function fetchWithLocalCache(url) {
                const key = `cache_${url}`;
                if (navigator.onLine) {
                  try {
                    const res = await fetch(url);
                    const data = await res.json();
                    localStorage.setItem(key, JSON.stringify(data));
                    return data;
                  } catch (e) {
                    console.warn('Network fetch failed, using cache.', e);
                  }
                }
                // offline or fetch failed
                const cached = localStorage.getItem(key);
                return cached ? JSON.parse(cached) : [];
              }
    
        // --- OPTIMIZATION: Update function is now leaner ---
        // It receives cached elements and data instead of querying the DOM itself.
        function updateBusPosition(stops, cachedStopElements, busMarker, currentTimeEl) {
            const now = new Date();
            const localTimeStr = now.toLocaleTimeString('en-GB', { timeZone: 'Asia/Kolkata' });
            const currentMinutes = timeToMinutes(localTimeStr);
            currentTimeEl.textContent = `Time: ${formatTime(now, true)}`;
    
            const startMin = cachedStopElements[0].timeInMinutes;
            const endMin = cachedStopElements[cachedStopElements.length - 1].timeInMinutes;
    
            let yBus;
            if (currentMinutes <= startMin) {
                yBus = 0;
            } else if (currentMinutes >= endMin) {
                yBus = cachedStopElements[cachedStopElements.length - 1].y;
            } else {
                const nextStopIndex = cachedStopElements.findIndex(st => st.timeInMinutes > currentMinutes);
                const prevStop = cachedStopElements[nextStopIndex - 1];
                const nextStop = cachedStopElements[nextStopIndex];
                
                const segmentDuration = nextStop.timeInMinutes - prevStop.timeInMinutes;
                const timeIntoSegment = currentMinutes - prevStop.timeInMinutes;
                const fraction = segmentDuration > 0 ? timeIntoSegment / segmentDuration : 0;
                yBus = prevStop.y + fraction * (nextStop.y - prevStop.y);
            }
            
            busMarker.style.top = yBus + 'px';
    
            // --- OPTIMIZATION: Iterate over cached elements, not a new query ---
            cachedStopElements.forEach(stop => {
                if (currentMinutes > stop.timeInMinutes) {
                    stop.element.classList.add('departed');
                    if (stop.etaElement) stop.etaElement.textContent = 'Departed';
                } else {
                    stop.element.classList.remove('departed');
                    if (stop.etaElement) stop.etaElement.textContent = `ETA: ${calculateETA(currentMinutes, stop.timeInMinutes)}`;
                }
            });
            let tooltipText;
                if (currentMinutes >= cachedStopElements[cachedStopElements.length - 1].timeInMinutes) {
                    const lastName = cachedStopElements[cachedStopElements.length - 1]
                    .element.querySelector('.stop-name').textContent.trim();
                    tooltipText = `Arrived at ${lastName}`;
                } else {
                    // Find previous stop
                    const prevIndex = cachedStopElements.findIndex(st => st.timeInMinutes > currentMinutes) - 1;
                    if (prevIndex >= 0) {
                    const prevName = cachedStopElements[prevIndex]
                        .element.querySelector('.stop-name').textContent.trim();
                    tooltipText = `Departed from ${prevName}`;
                    }
                }
                // Remove old tooltip
                // Only show tooltip based on flags
                const oldTip = busMarker.querySelector('.bus-tooltip');
                if (oldTip) oldTip.remove();

                if (tooltipText && shouldShowTooltip) {
                    const tip = document.createElement('div');
                    tip.className = 'bus-tooltip';
                    tip.textContent = tooltipText;
                    busMarker.appendChild(tip);

                    // Clear previous timeout
                    clearTimeout(tooltipTimeout);
                    tooltipTimeout = setTimeout(() => {
                        const stillTip = busMarker.querySelector('.bus-tooltip');
                        if (stillTip) stillTip.remove();
                    }, 3000);
                }



                // --- New: Show/hide button if marker is out of view ---
                const rect = busMarker.getBoundingClientRect();
                const viewHeight = window.innerHeight || document.documentElement.clientHeight;
                if (rect.top < 0 || rect.bottom > viewHeight) {
                    scrollBtn.style.display = 'flex';
                } else {
                    scrollBtn.style.display = 'none';
            }
            scrollBtn.addEventListener('click', () => {
                shouldShowTooltip = true;
                busMarker.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    shouldShowTooltip = false;
                }, 3000);
            });
            
        }

    
        // --- OPTIMIZATION: Event listeners are set up once ---
        function setupEventListeners(cachedStopElements) {
            document.getElementById('time-toggle').addEventListener('click', () => {
                is24Hour = !is24Hour;
                document.getElementById('time-toggle').textContent = is24Hour ? 'Switch to 12-hour' : 'Switch to 24-hour';
                cachedStopElements.forEach(stop => {
                    stop.timeElement.textContent = formatTime(stop.timeString, false);
                });
                // Also update the current time display format
                document.getElementById('current-time').textContent = `Time: ${formatTime(new Date(), true)}`;
            });
    
            const modal = document.getElementById('crowd-modal');
            const confirmCheckbox = document.getElementById('confirm-travel-checkbox');
    
            confirmCheckbox.addEventListener('change', e => {
                modal.style.display = e.target.checked ? 'flex' : 'none';
            });
    
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modal.style.display = 'none';
                confirmCheckbox.checked = false;
            });
            
            document.getElementById('submit-crowd-btn').addEventListener('click', submitCrowdData);
        }
    
        // --- MAIN FETCH AND RENDER LOGIC ---
        function fetchAndRenderTrip() {
            fetchWithLocalCache(`/api/bus/${BUS_ID}/current_trip`)
                .then(trip => {
                    

                    if (!trip || !Array.isArray(trip.stop_times)) {
                        throw new Error('No trip data');
                      }
                    recordThisTrip(trip);
                    const stopSpacing = 140;
                    const totalHeight = (trip.stop_times.length - 1) * stopSpacing;
    
                    // --- Build HTML string (this part is already efficient) ---
                    let stopsHtml = trip.stop_times.map(st => {
                         const yPos = (st.sequence - 1) * stopSpacing;
                         const crowdLevelMap = { 1: 'Expected Light crowd', 2: 'Expected Moderate crowd', 3: 'Expected High Crowd' };
                         let crowdTooltipHtml = st.crowd_report ? `
                            <div class="crowd-tooltip">
                                <strong><svg class="warning-symbol blinking" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor"><path d="M12 2L1 21h22L12 2zm1 16h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg> ${crowdLevelMap[st.crowd_report.crowd_level]}</strong>
                                ${st.crowd_report.description ? `<br/><marquee>${st.crowd_report.description}</marquee>` : ''}
                            </div>` : '';
                         
                         return `
                            <div class="stop" style="top:${yPos}px;" data-sequence="${st.sequence}">
                                <div class="stop-dot"></div>
                                <div class="stop-details">
                                    <div class="stop-name">${st.stop_name} ${crowdTooltipHtml}</div>
                                    <div class="stop-time" data-time="${st.arrival_time}">${formatTime(st.arrival_time, false)}</div>
                                    <div class="traffic-alert-container" data-traffic-for-sequence="${st.sequence}"></div>
                                    <div class="a1-las">
                                        <div class="eta-time" data-eta-for-sequence="${st.sequence}"></div>
                                        ${st.loc_link ? `<div style="display: flex;align-items: center;gap: 8px;" ><a href="${st.loc_link}" target="_blank" rel="noopener" class="loc-link"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 21C15.5 17.4 19 14.1764 19 10.2C19 6.22355 15.866 3 12 3C8.13401 3 5 6.22355 5 10.2C5 14.1764 8.5 17.4 12 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M12 12C13.1046 12 14 11.1046 14 10C14 8.89543 13.1046 8 12 8C10.8954 8 10 8.89543 10 10C10 11.1046 10.8954 12 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg> View on Map</a><a class="loc-link" href="/report-issue-page/${st.stop_name}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right:2px;" ><path d="M12 17V11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="1" cy="1" r="1" transform="matrix(1 0 0 -1 11 9)" fill="currentColor"/><path d="M7 3.33782C8.47087 2.48697 10.1786 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 10.1786 2.48697 8.47087 3.33782 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Report</a></div>` : ''}
                                    </div>
                                </div>
                            </div>`;
                    }).join('');
    
                    const pageHtml = `
                        <div class="header">
                            <a href="/" class="back-btn" aria-label="Go back"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></a>
                            <div><h2>${BUS_NAME}</h2><p>Route: ${trip.route_name} (${trip.direction})</p></div>
                        </div>
                        <div class="top-controls">
                            <span id="current-time"></span>
                            <button id="time-toggle">Switch to 12-hour</button>
                        </div>
                        <div class="main-container">
                            <div class="disclaimer">This scheduled bus time and timeline chart may be inaccurate based on traffic and other conditions.</div>
                            <div class="timeline-card">
                                <div class="timeline-container" style="height:${totalHeight + 40}px;">
                                    <div class="timeline-line"></div>
                                    ${stopsHtml}
                                    <div id="bus-marker" class="bus-marker"><svg width="22px" height="22px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C8.22876 2 6.34315 2 5.17157 3.17157C4.10848 4.23467 4.01004 5.8857 4.00093 9H3C2.44772 9 2 9.44772 2 10V11C2 11.3148 2.14819 11.6111 2.4 11.8L4 13C4.00911 16.1143 4.10848 17.7653 5.17157 18.8284C5.41375 19.0706 5.68645 19.2627 6 19.4151V20.9999C6 21.5522 6.44772 21.9999 7 21.9999H8.5C9.05228 21.9999 9.5 21.5522 9.5 20.9999V19.9815C10.2271 20 11.0542 20 12 20C12.9458 20 13.7729 20 14.5 19.9815V20.9999C14.5 21.5522 14.9477 21.9999 15.5 21.9999H17C17.5523 21.9999 18 21.5522 18 20.9999V19.4151C18.3136 19.2627 18.5862 19.0706 18.8284 18.8284C19.8915 17.7653 19.9909 16.1143 20 13L21.6 11.8C21.8518 11.6111 22 11.3148 22 11V10C22 9.44772 21.5523 9 21 9H19.9991C19.99 5.8857 19.8915 4.23467 18.8284 3.17157C17.6569 2 15.7712 2 12 2ZM5.5 9.5C5.5 10.9142 5.5 11.6213 5.93934 12.0607C6.37868 12.5 7.08579 12.5 8.5 12.5H12H15.5C16.9142 12.5 17.6213 12.5 18.0607 12.0607C18.5 11.6213 18.5 10.9142 18.5 9.5V7C18.5 5.58579 18.5 4.87868 18.0607 4.43934C17.6213 4 16.9142 4 15.5 4H12H8.5C7.08579 4 6.37868 4 5.93934 4.43934C5.5 4.87868 5.5 5.58579 5.5 7V9.5ZM6.25 16C6.25 15.5858 6.58579 15.25 7 15.25H8.5C8.91421 15.25 9.25 15.5858 9.25 16C9.25 16.4142 8.91421 16.75 8.5 16.75H7C6.58579 16.75 6.25 16.4142 6.25 16ZM17.75 16C17.75 15.5858 17.4142 15.25 17 15.25H15.5C15.0858 15.25 14.75 15.5858 14.75 16C14.75 16.4142 15.0858 16.75 15.5 16.75H17C17.4142 16.75 17.75 16.4142 17.75 16Z" fill="currentColor"/></svg></div>
                                </div>
                            </div>
                        </div>
                        <div id="crowd-section">
                            <div id="crowd-prediction"><p>Loading crowd prediction...</p></div>
                            <label><input type="checkbox" id="confirm-travel-checkbox" /><span>Are you on this bus? Help improve tracking.</span></label>
                        </div>
                    `;
                    tripInfo.innerHTML = pageHtml;
    
                    // --- OPTIMIZATION: Cache DOM elements and relevant data once after render ---
                    const busMarker = document.getElementById('bus-marker');
                    const currentTimeEl = document.getElementById('current-time');
                    const cachedStopElements = trip.stop_times.map(st => {
                        const stopEl = document.querySelector(`.stop[data-sequence="${st.sequence}"]`);
                        return {
                            element: stopEl,
                            etaElement: stopEl.querySelector(`.eta-time`),
                            timeElement: stopEl.querySelector('.stop-time'),
                            timeString: st.arrival_time,
                            timeInMinutes: timeToMinutes(st.arrival_time),
                            y: (st.sequence - 1) * stopSpacing
                        };
                    });
                    
                    // Initial setup
                    setupEventListeners(cachedStopElements);
                    updateBusPosition(trip.stop_times, cachedStopElements, busMarker, currentTimeEl);
                    setInterval(() => updateBusPosition(trip.stop_times, cachedStopElements, busMarker, currentTimeEl), 2000);
    
                    // Scroll to bus marker after a brief moment to ensure rendering
                    setTimeout(() => {
                        if (busMarker) {
                            busMarker.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        shouldShowTooltip = true;
                    }, 100);
                    
    
                    // Load additional data
                    loadCrowdPrediction();
                    loadTrafficNotifications();
                })
                .catch(() => {
                    tripInfo.innerHTML = '<p style="text-align: center; padding-top: 50px;">No current trip found for this bus or an error occurred.</p>';
                });
        }
    
        // --- OTHER FUNCTIONS (Unchanged, but now called from the main flow) ---
        function loadTrafficNotifications() {
            fetchWithLocalCache(`/api/bus/${BUS_ID}/traffic_notifications`)
                .then(notifications => {
                    document.querySelectorAll('.traffic-alert-container').forEach(el => el.innerHTML = '');
                    notifications.forEach(notif => {
                        const container = document.querySelector(`[data-traffic-for-sequence="${notif.stop_sequence}"]`);
                        if (container) {
                            container.innerHTML = `<div class="traffic-alert"><strong>Traffic Alert:</strong> ${notif.description}</div>`;
                        }
                    });
                })
                .catch(err => console.error("Failed to load traffic notifications:", err));
        }
    
        function loadCrowdPrediction() {
            fetchWithLocalCache(`/api/bus/${BUS_ID}/crowd_prediction`)
                .then(pred => {
                    const cp = document.getElementById('crowd-prediction');
                    cp.innerHTML = pred.predicted_level === null
                        ? `<p><strong>Notification:</strong> ${pred.description}</p>`
                        : `<p><strong>Notification:</strong> ${pred.description} (based on ${pred.based_on_count} reports).${pred.recommended_action ? `<br/><em>${pred.recommended_action}</em>` : ''}</p>`;
                })
                .catch(() => {
                    document.getElementById('crowd-prediction').innerHTML = '<p>Crowd prediction is currently unavailable.</p>';
                });
        }
    
        function submitCrowdData() {
            const crowdLevel = +document.getElementById('crowd-level').value;
            const statusEl = document.getElementById('submit-status');
            statusEl.textContent = 'Submitting...';
            fetch(`/api/bus/${BUS_ID}/submit_crowd`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ crowd_level: crowdLevel })
            })
            .then(res => {
                if (!res.ok) return Promise.reject(new Error('Submission failed'));
                return res.json();
            })
            .then(() => {
                statusEl.textContent = 'Thank you for your contribution!';
                setTimeout(() => {
                    document.getElementById('crowd-modal').style.display = 'none';
                    document.getElementById('confirm-travel-checkbox').checked = false;
                    statusEl.textContent = '';
                }, 1500);
                setTimeout(loadCrowdPrediction, 500);
            })
            .catch(() => {
                statusEl.textContent = 'Error during submission. Please try again.';
            });
        }
    
        // --- INITIALIZE ---
        fetchAndRenderTrip();
    
    </script>
    <script>
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.error('SW registration failed:', err));
        }
      </script>
</body>
</html>
