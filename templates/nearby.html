<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nearby Stops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        /* --- App Theme & Variables (Consistent with Search Page) --- */
        :root {
            --primary-color: #D32F2F; /* Bold Red */
            --primary-dark: #B71C1C;
            --success-color: #10b981;
            --background-color: #F5F5F5;
            --card-background: #FFFFFF;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border-color: #E0E0E0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            height: 100vh;
            background: var(--background-color);
            color: var(--text-primary);
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        #map {
            flex-grow: 1;
            width: 100%;
            z-index: 1;
        }

        /* --- App Header --- */
        .app-header {
            display: flex;
            align-items: center;
            background-color: var(--primary-color);
            padding: 15px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1005;
            flex-shrink: 0;
        }
        .app-header .back-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-right: 15px;
        }
        .app-header .back-btn svg { width: 28px; height: 28px; }
        .app-header h1 {
            font-size: 1.25em;
            font-weight: 600;
        }

        /* --- Floating Action Button --- */
        .find-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 1001;
        }
        .find-btn:hover { background: var(--primary-dark); }
        .find-btn.loading {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: scale(0.95);
        }

        /* --- Status Toast --- */
        .status-toast {
            position: fixed;
            top: 80px; /* Below header */
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--card-background);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            z-index: 1002;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .status-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        .status-toast.error { background: #fef2f2; color: #dc2626; border-color: #fecaca; }

        /* --- Bottom Sheet --- */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-background);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgb(0 0 0 / 0.15);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1003;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .bottom-sheet.open { transform: translateY(0); }
        
        .sheet-header {
            padding: 12px 20px 16px;
            text-align: center;
            flex-shrink: 0;
        }
        .drag-handle {
            width: 40px;
            height: 5px;
            background: var(--border-color);
            border-radius: 2.5px;
            margin: 0 auto 12px;
            cursor: grab;
        }
        .drag-handle:active { cursor: grabbing; }

        .sheet-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .sheet-subtitle { font-size: 14px; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .distance-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .sheet-content {
            padding: 0 15px 15px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* --- Bus List --- */
        .bus-list { display: flex; flex-direction: column; gap: 12px; }
        .bus-item {
            background: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .bus-item:hover { border-color: var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .bus-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .bus-name { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .bus-check {
            background: var(--primary-color);
            color: white;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-decoration: none;
            transition: background 0.2s ease;
        }
        .bus-check:hover { background: var(--primary-dark); }
        .trip-name { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .arrival-info { display: flex; align-items: center; gap: 8px; }
        .arrival-time { font-weight: 600; color: var(--success-color); font-size: 14px; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-icon { font-size: 48px; margin: 0 auto 16px; opacity: 0.5; }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Map Legend & Controls --- */
        .leaflet-control-container .leaflet-top.leaflet-right { top: 70px; }
        .leaflet-control-zoom { border: 1px solid var(--border-color) !important; border-radius: 8px !important; }
        .map-legend {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            font-size: 12px;
            line-height: 1.4;
        }
        .legend-title { font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; color: var(--text-secondary); }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-icon { width: 16px; height: 16px; }

        .leaflet-routing-container { display: none !important; }

        @media (max-width: 768px) {
            .find-btn { bottom: 20px; right: 15px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <a href="/" class="back-btn" aria-label="Go back">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </a>
            <h1>Stops Near Me</h1>
        </header>

        <div id="map"></div>

        <button class="find-btn" id="find-btn">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        </button>

        <div class="status-toast" id="status-toast">
            <div class="spinner"></div>
            <span id="status-text">Ready to find your location</span>
        </div>

        <div class="bottom-sheet" id="bottom-sheet">
            <div class="sheet-header" id="sheet-header">
                <div class="drag-handle" id="drag-handle"></div>
                <div>
                    <div class="sheet-title" id="sheet-title">Nearest Bus Stop</div>
                    <div class="sheet-subtitle">
                        <span id="stop-name">‚Äî</span>
                        <span class="distance-badge" id="stop-distance">‚Äî away</span>
                    </div>
                </div>
            </div>
            <div class="sheet-content">
                <div class="bus-list" id="bus-list">
                    <!-- Bus items populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const findBtn = document.getElementById('find-btn');
            const statusToast = document.getElementById('status-toast');
            const statusText = document.getElementById('status-text');
            const bottomSheet = document.getElementById('bottom-sheet');
            const sheetHeader = document.getElementById('sheet-header');
            const stopName = document.getElementById('stop-name');
            const stopDistance = document.getElementById('stop-distance');
            const busList = document.getElementById('bus-list');

            // --- THEME COLORS ---
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();

            // --- CUSTOM ICONS ---
            const userIconSVG = `data:image/svg+xml;base64,${btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${primaryColor}" width="32px" height="32px"><circle cx="12" cy="12" r="10" fill="#ffffff" stroke="${primaryColor}" stroke-width="2"/><circle cx="12" cy="12" r="4" fill="${primaryColor}"/></svg>`)}`;
            const stopIconSVG = `data:image/svg+xml;base64,${btoa(`<svg fill="${successColor}" height="32px" width="32px" version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 32 32" xml:space="preserve">
<path d="M32,18.9l-0.8-6.2c-0.2-1.5-1.5-2.6-3-2.6H1c-0.6,0-1,0.4-1,1v13c0,0.6,0.4,1,1,1h3.2c0.4,1.2,1.5,2,2.8,2c1,0,2-0.5,2.5-1.3C10,26.5,11,27,12,27c1.3,0,2.4-0.8,2.8-2h7.4c0.4,1.2,1.5,2,2.8,2s2.4-0.8,2.8-2H31c0.6,0,1-0.4,1-1v-5C32,19,32,18.9,32,18.9z M28.2,12c0.5,0,0.9,0.4,1,0.9l0.6,5.1h-1c-1.6,0-3-0.6-4.1-1.7C24.5,16.1,24.3,16,24,16H2v-4H28.2z M7,25 c-0.6,0-1-0.4-1-1c0,0,0,0,0,0s0,0,0,0c0-0.6,0.4-1,1-1c0.6,0,1,0.4,1,1S7.6,25,7,25z M12,25c-0.6,0-1-0.4-1-1s0.4-1,1-1s1,0.4,1,1S12.6,25,12,25z M25,25c-0.6,0-1-0.4-1-1s0.4-1,1-1s1,0.4,1,1S25.6,25,25,25z"/></svg>`)}`;

            const userIcon = L.icon({ iconUrl: userIconSVG, iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -16] });
            const stopIcon = L.icon({ iconUrl: stopIconSVG, iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
            
            // --- MAP INITIALIZATION ---
            const map = L.map('map', { zoomControl: false }).setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);

            const legend = L.control({ position: 'bottomleft' });
            legend.onAdd = function () {
                const div = L.DomUtil.create('div', 'map-legend');
                div.innerHTML = `<div class="legend-title">Legend</div><div class="legend-item"><img src="${userIconSVG}" class="legend-icon"> Your Location</div><div class="legend-item"><img src="${stopIconSVG}" class="legend-icon"> Bus Stop</div>`;
                return div;
            };
            legend.addTo(map);

            let userMarker, stopMarker, routingControl;
            
            // --- UI FUNCTIONS ---
            function showStatus(message, isError = false, showSpinner = true) {
                statusText.textContent = message;
                statusToast.className = `status-toast show ${isError ? 'error' : ''}`;
                statusToast.querySelector('.spinner').style.display = showSpinner && !isError ? 'block' : 'none';
            }
            function hideStatus() { statusToast.classList.remove('show'); }
            function openBottomSheet() { bottomSheet.classList.add('open'); }
            function closeBottomSheet() { bottomSheet.classList.remove('open'); }

            // --- BOTTOM SHEET DRAG LOGIC ---
            let isDragging = false, startY = 0, currentY = 0;
            sheetHeader.addEventListener('mousedown', startDrag);
            sheetHeader.addEventListener('touchstart', startDrag, { passive: false });

            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                bottomSheet.style.transition = 'none';
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('touchmove', onDrag);
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
            }
            function onDrag(e) {
                if (!isDragging) return;
                currentY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
                const diff = currentY - startY;
                if (diff > 0) bottomSheet.style.transform = `translateY(${diff}px)`;
            }
            function endDrag() {
                if (!isDragging) return;
                isDragging = false;
                bottomSheet.style.transition = '';
                const diff = currentY - startY;
                if (diff > 100) closeBottomSheet();
                else bottomSheet.style.transform = '';
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('touchmove', onDrag);
                document.removeEventListener('mouseup', endDrag);
                document.removeEventListener('touchend', endDrag);
            }

            // --- GEOLOCATION LOGIC ---
            findBtn.addEventListener('click', () => {
                if (findBtn.classList.contains('loading')) return;
                findBtn.classList.add('loading');
                showStatus('Locating you...');
                closeBottomSheet();
                if (!navigator.geolocation) {
                    showStatus('Geolocation not supported', true, false);
                    findBtn.classList.remove('loading');
                    return;
                }
                navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, { enableHighAccuracy: true });
            });

            async function onLocationSuccess(position) {
                const { latitude, longitude } = position.coords;
                showStatus('Location found, fetching bus data...');
                const userLatLng = L.latLng(latitude, longitude);

                if (userMarker) userMarker.setLatLng(userLatLng);
                else userMarker = L.marker(userLatLng, { icon: userIcon }).addTo(map).bindPopup('<strong>üìç Your Location</strong>');
                map.setView(userLatLng, 16);

                try {
                    const response = await fetch(`/api/nearby_buses?lat=${latitude}&lon=${longitude}`);
                    if (!response.ok) throw new Error((await response.json().catch(() => ({ detail: 'Server error' }))).detail);
                    const data = await response.json();
                    displayResults(data, userLatLng);
                } catch (err) {
                    showStatus(`Error: ${err.message}`, true, false);
                    findBtn.classList.remove('loading');
                }
            }

            function onLocationError(err) {
                showStatus(`Location error: ${err.message}`, true, false);
                findBtn.classList.remove('loading');
            }

            // --- DISPLAY RESULTS ---
            function displayResults(data, userLatLng) {
                hideStatus();
                findBtn.classList.remove('loading');
                const stop = data.nearest_stop;
                const stopLatLng = L.latLng(parseFloat(stop.latitude), parseFloat(stop.longitude));
                
                stopName.textContent = stop.name;
                stopDistance.textContent = `${Math.round(map.distance(userLatLng, stopLatLng))}m away`;

                const popupContent = `<strong>üöè ${stop.name}</strong><br>Distance: ${Math.round(map.distance(userLatLng, stopLatLng))}m`;
                if (stopMarker) stopMarker.setLatLng(stopLatLng).setPopupContent(popupContent);
                else stopMarker = L.marker(stopLatLng, { icon: stopIcon }).addTo(map).bindPopup(popupContent);

                if (routingControl) map.removeControl(routingControl);
                routingControl = L.Routing.control({
                    waypoints: [userLatLng, stopLatLng],
                    show: false,
                    createMarker: () => null,
                    lineOptions: { styles: [{ color: primaryColor, opacity: 0.8, weight: 5 }] }
                }).addTo(map);

                busList.innerHTML = '';
                if (!data.arrivals || data.arrivals.length === 0) {
                    busList.innerHTML = `<div class="empty-state"><div class="empty-icon">üöå</div><p>No upcoming buses at this stop.</p></div>`;
                } else {
                    data.arrivals.forEach(arrival => {
                        const busItem = document.createElement('div');
                        busItem.className = 'bus-item';
                        busItem.innerHTML = `<div class="bus-header"><div class="bus-name">${arrival.bus_name}</div><a href="/redirect_to_current_trip/${arrival.bus_id}" class="bus-check">Track</a></div><div class="trip-name">${arrival.trip_name}</div><div class="arrival-info"><span>Arrives:</span><span class="arrival-time">${arrival.arrival_time}</span></div>`;
                        busItem.addEventListener('click', (e) => { if (e.target.tagName !== 'A') { map.setView(stopLatLng, 17); stopMarker.openPopup(); } });
                        busList.appendChild(busItem);
                    });
                }
                map.fitBounds([userLatLng, stopLatLng], { padding: [50, 50] });
                setTimeout(() => openBottomSheet(), 500);
            }
        });
    </script>
</body>
</html>
